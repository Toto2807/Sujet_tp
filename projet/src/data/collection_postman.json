{
  "info": {
    "name": "Scan API — Local Test Suite",
    "_postman_id": "6ec8c43a-4ee4-4516-8e2e-dbdd2d7fd08e",
    "description": "Collection Postman prête à l'emploi pour tester l'API Scan (auth, manga, chapters, fav, history). Les variables de collection contiennent l'URL et les identifiants de test. Les scripts enregistrent automatiquement les tokens et IDs.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Register user",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "register"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{username_user}}\",\n  \"email\": \"{{email_user}}\",\n  \"password\": \"{{password_user}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"Status 201 or 409 (already exists)\", function () {",
                  "  pm.expect([201,409]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 201) {",
                  "  const json = pm.response.json();",
                  "  pm.collectionVariables.set(\"accessToken\", json.tokens.access);",
                  "  pm.collectionVariables.set(\"refreshToken\", json.tokens.refresh);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Login user",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{email_user}}\",\n  \"password\": \"{{password_user}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"Login OK\", function () { pm.response.to.be.success; });",
                  "const json = pm.response.json();",
                  "pm.collectionVariables.set(\"accessToken\", json.tokens.access);",
                  "pm.collectionVariables.set(\"refreshToken\", json.tokens.refresh);",
                  ""
                ]
              }
            }
          ]
        },
        {
          "name": "Refresh token (user)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/auth/refresh",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "refresh"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refresh_token\": \"{{refreshToken}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"Refresh OK\", function () { pm.response.to.be.success; });",
                  "const json = pm.response.json();",
                  "pm.collectionVariables.set(\"accessToken\", json.tokens.access);",
                  ""
                ]
              }
            }
          ]
        },
        {
          "name": "Login admin (si déjà créé)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{email_admin}}\",\n  \"password\": \"{{password_admin}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "if (pm.response.code === 200) {",
                  "  const json = pm.response.json();",
                  "  pm.collectionVariables.set(\"adminAccessToken\", json.tokens.access);",
                  "} else {",
                  "  pm.test(\"Admin non dispo\", function () { pm.expect(pm.response.code).to.be.oneOf([200,401,404]); });",
                  "}",
                  ""
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Manga",
      "item": [
        {
          "name": "GET /manga (list)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/manga",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "manga"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK\", function(){ pm.response.to.be.success; });"
                ]
              }
            }
          ]
        },
        {
          "name": "POST /manga (create) [admin/moderateur]",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/manga",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "manga"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"One Piece Test\",\n  \"description\": \"Pirates et grande aventure\",\n  \"author\": \"Eiichiro Oda\",\n  \"artist\": \"Eiichiro Oda\",\n  \"tags\": [\n    \"aventure\",\n    \"pirate\"\n  ],\n  \"cover_url\": \"https://example.com/cover.jpg\",\n  \"published_at\": \"1997-07-22\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"Created or Forbidden\", function(){",
                  "  pm.expect([201,403,401]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 201) {",
                  "  const json = pm.response.json();",
                  "  pm.collectionVariables.set(\"mangaId\", json.id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /manga/:id (by id)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/manga/{{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "manga",
                "{{mangaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"OK/404\", function(){",
                  "  pm.expect([200,404]).to.include(pm.response.code);",
                  "});",
                  ""
                ]
              }
            }
          ]
        },
        {
          "name": "PUT /manga/:id (update) [admin/moderateur]",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/manga/{{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "manga",
                "{{mangaId}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"description\": \"Mise à jour description via Postman\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Updated or Forbidden\", function(){ pm.expect([200,403,401,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /manga/:id [admin]",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/manga/{{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "manga",
                "{{mangaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Deleted or Forbidden\", function(){ pm.expect([200,403,401,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Chapters (Mongo)",
      "item": [
        {
          "name": "GET /chapters?manga_id=",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/chapters?manga_id={{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "chapters?manga_id={{mangaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK\", function(){ pm.response.to.be.success; });"
                ]
              }
            }
          ]
        },
        {
          "name": "POST /chapters [admin/moderateur]",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/chapters",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "chapters"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"manga_id\": \"{{mangaId}}\",\n  \"chap_number\": 1,\n  \"chap_title\": \"Chapitre 1\",\n  \"pages\": [\n    {\n      \"index\": 1,\n      \"image_url\": \"https://example.com/1.jpg\"\n    },\n    {\n      \"index\": 2,\n      \"image_url\": \"https://example.com/2.jpg\"\n    }\n  ]\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"Created or Forbidden\", function(){ pm.expect([201,403,401,409]).to.include(pm.response.code); });",
                  "if (pm.response.code === 201) {",
                  "  const json = pm.response.json();",
                  "  pm.collectionVariables.set(\"chapterId\", json._id);",
                  "  pm.collectionVariables.set(\"lastChapterId\", json._id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /chapters/:id",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/chapters/{{chapterId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "chapters",
                "{{chapterId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK/404\", function(){ pm.expect([200,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        },
        {
          "name": "PUT /chapters/:id [admin/moderateur]",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/chapters/{{chapterId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "chapters",
                "{{chapterId}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"chap_title\": \"Chapitre 1 — MAJ\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK/Forbidden/404\", function(){ pm.expect([200,403,401,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /chapters/:id [admin]",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/chapters/{{chapterId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "chapters",
                "{{chapterId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK/Forbidden/404\", function(){ pm.expect([200,403,401,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Favs",
      "item": [
        {
          "name": "GET /favs (my favs)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/favs",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "favs"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK\", function(){ pm.response.to.be.success; });"
                ]
              }
            }
          ]
        },
        {
          "name": "POST /favs (add)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/favs",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "favs"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id_manga\": \"{{mangaId}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Created/OK\", function(){ pm.expect([201,200,400,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /favs/:manga_id",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/favs/{{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "favs",
                "{{mangaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK\", function(){ pm.expect([200,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "History",
      "item": [
        {
          "name": "GET /history (my history)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/history",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "history"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK\", function(){ pm.response.to.be.success; });"
                ]
              }
            }
          ]
        },
        {
          "name": "POST /history (upsert)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/history",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "history"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"manga_id\": \"{{mangaId}}\",\n  \"last_chapter_id\": \"{{lastChapterId}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Created/OK\", function(){ pm.expect([201,200,400,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /history/:manga_id",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/history/{{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "history",
                "{{mangaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK/404\", function(){ pm.expect([200,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /history/:manga_id",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/history/{{mangaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "history",
                "{{mangaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"OK/404\", function(){ pm.expect([200,404]).to.include(pm.response.code); });"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000/api"
    },
    {
      "key": "email_user",
      "value": "user1@example.com"
    },
    {
      "key": "password_user",
      "value": "user123456"
    },
    {
      "key": "username_user",
      "value": "user1"
    },
    {
      "key": "email_admin",
      "value": "admin@example.com"
    },
    {
      "key": "password_admin",
      "value": "Admin123456!"
    },
    {
      "key": "username_admin",
      "value": "admin"
    },
    {
      "key": "accessToken",
      "value": ""
    },
    {
      "key": "refreshToken",
      "value": ""
    },
    {
      "key": "adminAccessToken",
      "value": ""
    },
    {
      "key": "mangaId",
      "value": ""
    },
    {
      "key": "chapterId",
      "value": ""
    },
    {
      "key": "lastChapterId",
      "value": ""
    }
  ]
}